name: Comprehensive CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ä»£ç æ ¼å¼æ£€æŸ¥
  formatting:
    name: ğŸ¨ Code Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        
      - name: Install dependencies
        run: uv sync --extra dev
        
      - name: Check formatting with Ruff
        run: |
          echo "Checking code formatting..."
          uv run ruff format --check --diff src/ tests/ examples/

  # ä»£ç è´¨é‡æ£€æŸ¥
  linting:
    name: ğŸ” Code Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        
      - name: Install dependencies
        run: uv sync --extra dev
        
      - name: Run Ruff linting
        run: |
          echo "Running Ruff linting checks..."
          uv run ruff check src/ tests/ examples/ --output-format=github
          
      - name: Run Pylint
        run: |
          echo "Running Pylint analysis..."
          uv run pylint src/ --rcfile=pylint.toml --output-format=colorized
        continue-on-error: true

  # ç±»å‹æ£€æŸ¥
  type-checking:
    name: ğŸ” Type Checking
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        
      - name: Install dependencies
        run: uv sync --extra dev
        
      - name: Run MyPy type checking
        run: |
          echo "Running MyPy type checking..."
          uv run mypy src/ --show-error-codes --pretty
        continue-on-error: true

  # å®‰å…¨æ£€æŸ¥
  security:
    name: ğŸ”’ Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        
      - name: Install dependencies
        run: uv sync --extra dev
        
      - name: Run Bandit security check
        run: |
          echo "Running Bandit security analysis..."
          uv run bandit -r src/ -f json -o bandit-report.json
          uv run bandit -r src/ -f txt
        continue-on-error: true
        
      - name: Run Safety vulnerability check
        run: |
          echo "Checking for known security vulnerabilities..."
          uv run safety check --json --output safety-report.json
          uv run safety check
        continue-on-error: true
        
      - name: Upload security reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

  # å•å…ƒæµ‹è¯•
  testing:
    name: ğŸ§ª Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          
      - name: Install uv
        uses: astral-sh/setup-uv@v3
        
      - name: Install dependencies
        run: uv sync --extra dev
        
      - name: Create JPlag jar placeholder
        run: |
          mkdir -p lib
          echo "Mock JPlag jar" > lib/jplag-6.2.0.jar
        
      - name: Run tests with coverage
        run: |
          echo "Running unit tests with coverage..."
          uv run pytest tests/ -v \
            --cov=src \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --tb=short
            
      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 30

  # ç»¼åˆè´¨é‡æ£€æŸ¥
  quality-gate:
    name: ğŸ¯ Quality Gate
    runs-on: ubuntu-latest
    needs: [formatting, linting, type-checking, security, testing]
    if: always()
    steps:
      - name: Check quality gate
        run: |
          echo "## ğŸ“Š Code Quality Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ¨ Formatting: ${{ needs.formatting.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Linting: ${{ needs.linting.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ” Type Checking: ${{ needs.type-checking.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”’ Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª Testing: ${{ needs.testing.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ£€æŸ¥å¿…éœ€çš„æ£€æŸ¥æ˜¯å¦é€šè¿‡
          if [[ "${{ needs.formatting.result }}" != "success" ]]; then
            echo "âŒ Code formatting check failed!"
            exit 1
          fi
          
          if [[ "${{ needs.linting.result }}" != "success" ]]; then
            echo "âŒ Code linting check failed!"
            exit 1
          fi
          
          if [[ "${{ needs.testing.result }}" != "success" ]]; then
            echo "âŒ Unit tests failed!"
            exit 1
          fi
          
          echo "âœ… All required quality checks passed!"
