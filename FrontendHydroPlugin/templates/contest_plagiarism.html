{% extends "layout/base.html" %}

{% block content %}
<div class="section">
  <div class="section__header">
    <h1 class="section__title">{{ _('Plagiarism Detection') }} - {{ contest.title }}</h1>
  </div>
  
  <div class="section__body">
    <!-- Control Panel -->
    <div class="widget">
      <div class="widget-header">
        <h3>{{ _('Analysis Controls') }}</h3>
      </div>
      <div class="widget-body">
        <form class="form" method="post" data-form-auto-ajax>
          <input type="hidden" name="action" value="analyze">
          <input type="hidden" name="contestId" value="{{ contestId }}">
          
          <div class="row">
            <div class="columns medium-6">
              <label class="form__label">
                {{ _('Minimum Tokens') }}
                <div class="form__item">
                  <input class="textbox" type="number" name="min_tokens" value="9" min="1" max="100">
                  <div class="form__desc">{{ _('Minimum number of tokens to match') }}</div>
                </div>
              </label>
            </div>
            
            <div class="columns medium-6">
              <label class="form__label">
                {{ _('Similarity Threshold') }}
                <div class="form__item">
                  <input class="textbox" type="number" name="similarity_threshold" value="0.0" min="0" max="1" step="0.1">
                  <div class="form__desc">{{ _('Minimum similarity threshold (0.0-1.0)') }}</div>
                </div>
              </label>
            </div>
          </div>
          
          <div class="form__item">
            <button class="button button--primary" type="submit">
              {{ _('Start Plagiarism Analysis') }}
            </button>
            <button class="button button--secondary" type="button" id="refresh-results">
              {{ _('Refresh Results') }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Results Section -->
    <div class="widget" id="results-section">
      <div class="widget-header">
        <h3>{{ _('Analysis Results') }}</h3>
      </div>
      <div class="widget-body">
        {% if results %}
          {% for result in results %}
          <div class="panel panel--default">
            <div class="panel__header">
              <h4>{{ _('Problem') }} {{ result.problem_id }} - {{ _('Analysis') }} {{ result.analysis_id[:8] }}...</h4>
              <small class="text-muted">{{ _('Created at') }}: {{ result.created_at }}</small>
            </div>
            <div class="panel__body">
              <div class="row">
                <div class="columns medium-4">
                  <div class="stat">
                    <div class="stat__value">{{ result.total_submissions }}</div>
                    <div class="stat__label">{{ _('Total Submissions') }}</div>
                  </div>
                </div>
                <div class="columns medium-4">
                  <div class="stat">
                    <div class="stat__value">{{ result.total_comparisons }}</div>
                    <div class="stat__label">{{ _('Total Comparisons') }}</div>
                  </div>
                </div>
                <div class="columns medium-4">
                  <div class="stat">
                    <div class="stat__value">{{ (result.execution_time_ms / 1000) | round(2) }}s</div>
                    <div class="stat__label">{{ _('Execution Time') }}</div>
                  </div>
                </div>
              </div>

              {% if result.high_similarity_pairs %}
              <div class="section__subsection">
                <h5>{{ _('High Similarity Pairs') }}</h5>
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        <th>{{ _('First Submission') }}</th>
                        <th>{{ _('Second Submission') }}</th>
                        <th>{{ _('Average Similarity') }}</th>
                        <th>{{ _('Max Similarity') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for pair in result.high_similarity_pairs %}
                      <tr>
                        <td>{{ pair.first_submission }}</td>
                        <td>{{ pair.second_submission }}</td>
                        <td>
                          <span class="badge {% if pair.similarities.AVG > 0.7 %}badge--danger{% elif pair.similarities.AVG > 0.5 %}badge--warning{% else %}badge--info{% endif %}">
                            {{ (pair.similarities.AVG * 100) | round(1) }}%
                          </span>
                        </td>
                        <td>
                          <span class="badge {% if pair.similarities.MAX > 0.8 %}badge--danger{% elif pair.similarities.MAX > 0.6 %}badge--warning{% else %}badge--info{% endif %}">
                            {{ (pair.similarities.MAX * 100) | round(1) }}%
                          </span>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
              {% endif %}

              {% if result.clusters %}
              <div class="section__subsection">
                <h5>{{ _('Detected Clusters') }}</h5>
                {% for cluster in result.clusters %}
                <div class="panel panel--info">
                  <div class="panel__header">
                    <strong>{{ _('Cluster') }} {{ cluster.index }}</strong>
                    <small>({{ _('Avg Similarity') }}: {{ (cluster.average_similarity * 100) | round(1) }}%, 
                           {{ _('Strength') }}: {{ (cluster.strength * 100) | round(1) }}%)</small>
                  </div>
                  <div class="panel__body">
                    <div class="tags">
                      {% for member in cluster.members %}
                      <span class="tag">{{ member }}</span>
                      {% endfor %}
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
              {% endif %}

              {% if result.submission_stats %}
              <details class="section__subsection">
                <summary>{{ _('Submission Statistics') }} ({{ result.submission_stats | length }})</summary>
                <div class="table-responsive">
                  <table class="table table--striped">
                    <thead>
                      <tr>
                        <th>{{ _('Submission ID') }}</th>
                        <th>{{ _('Display Name') }}</th>
                        <th>{{ _('File Count') }}</th>
                        <th>{{ _('Total Tokens') }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for stat in result.submission_stats %}
                      <tr>
                        <td><code>{{ stat.submission_id }}</code></td>
                        <td>{{ stat.display_name }}</td>
                        <td>{{ stat.file_count }}</td>
                        <td>{{ stat.total_tokens }}</td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </details>
              {% endif %}

              {% if result.failed_submissions %}
              <div class="section__subsection">
                <h5 class="text-warning">{{ _('Failed Submissions') }}</h5>
                <ul>
                  {% for failed in result.failed_submissions %}
                  <li>{{ failed }}</li>
                  {% endfor %}
                </ul>
              </div>
              {% endif %}
            </div>
          </div>
          {% endfor %}
        {% else %}
        <div class="empty">
          <div class="empty__icon">ðŸ“Š</div>
          <div class="empty__title">{{ _('No Analysis Results') }}</div>
          <div class="empty__desc">{{ _('Click "Start Plagiarism Analysis" to begin analyzing contest submissions.') }}</div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
$(document).ready(function() {
  // Handle refresh results button
  $('#refresh-results').click(function() {
    $.post(window.location.href, {
      action: 'getResults',
      contestId: '{{ contestId }}'
    }, function(data) {
      if (data.success) {
        // Reload the page to show updated results
        window.location.reload();
      } else {
        Notification.error(data.message || 'Failed to refresh results');
      }
    }).fail(function() {
      Notification.error('Network error while refreshing results');
    });
  });

  // Handle form submission
  $('form[data-form-auto-ajax]').submit(function(e) {
    e.preventDefault();
    var $form = $(this);
    var $btn = $form.find('button[type="submit"]');
    var originalText = $btn.text();
    
    $btn.text('{{ _("Analyzing...") }}').prop('disabled', true);
    
    $.post(window.location.href, $form.serialize(), function(data) {
      if (data.success) {
        Notification.success(data.message || 'Analysis completed successfully');
        // Reload to show new results
        setTimeout(function() {
          window.location.reload();
        }, 2000);
      } else {
        Notification.error(data.message || 'Analysis failed');
      }
    }).fail(function(xhr) {
      var errorMsg = 'Analysis failed';
      try {
        var response = JSON.parse(xhr.responseText);
        errorMsg = response.message || errorMsg;
      } catch (e) {
        // Use default error message
      }
      Notification.error(errorMsg);
    }).always(function() {
      $btn.text(originalText).prop('disabled', false);
    });
  });
});
</script>
{% endblock %}